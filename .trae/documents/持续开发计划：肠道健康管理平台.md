## 阶段目标
- Phase 1（核心记录与分析）：完成数据记录表单、基础分析与预警、OAuth2认证、离线缓存与PWA壳、REST API与PostgreSQL数据层。
- Phase 2（同步与多设备、隐私增强）：端到端加密云同步、冲突解决策略、数据导出/删除、2FA。
- Phase 3（扩展分析与对接）：饮食关联分析、健康评分迭代、FHIR/微信小程序接口预留与初步联通。

## 技术架构
- 前端：React + TypeScript + Vite，PWA（Service Worker、Web App Manifest）、IndexedDB（idb封装）。
- 后端：Node.js（NestJS/Express二选一，倾向NestJS以模块化与AOP能力），RESTful API。
- 数据库：PostgreSQL（结构化关系、事务与扩展分析），后续可引入 MongoDB 作为事件存档或日志。
- 身份认证：OAuth2.0 + OIDC（可接入 Auth0/Keycloak/自建），支持可选TOTP 2FA。
- 云部署：Docker容器化，云托管（Kubernetes 或托管容器服务），水平扩展与滚动升级。

## 数据模型（v1）
- `users`：id，email，oauth_provider，status，created_at。
- `devices`：id，user_id，device_fingerprint，created_at。
- `stool_entries`：id，user_id，timestamp_minute，bristol_type(1-7)，smell_score(1-5)，color(enum)，volume(enum: small|medium|large)，symptoms(string[])，notes，created_at，updated_at，version。
- `diet_logs`：id，user_id，timestamp，items(json)，tags。
- `analytics_cache`：id，user_id，period(week|month|quarter)，metrics(json)，updated_at。
- `alerts`：id，user_id，type(enum: constipation|diarrhea|custom)，status(enum: active|resolved)，triggered_at，metadata(json)。
- `privacy_requests`：id，user_id，type(enum: export|delete)，status，requested_at，processed_at。

## 后端API设计
- 认证：`POST /auth/login`，`POST /auth/refresh`，`POST /auth/logout`，`GET /auth/me`。
- 记录CRUD：`GET/POST /entries`，`GET/PUT/DELETE /entries/:id`（乐观并发：If-Match + `version`）。
- 分析：`GET /analytics/frequency?period=week|month|quarter`，`GET /analytics/score`。
- 预警：`GET /alerts`，`POST /alerts/ack/:id`。
- 饮食关联：`GET /diet/associations`，`POST /diet/logs`，`GET /diet/logs`。
- 隐私合规：`POST /privacy/export`，`POST /privacy/delete`，`GET /privacy/status/:id`。
- 同步：`POST /sync/push`，`GET /sync/pull`（增量，同步游标）。

## 前端页面与组件
- 页面：登录/注册、首页（趋势与预警）、记录表单、历史记录列表与详情、分析仪表盘、设置（隐私与同步）。
- 组件：
  - 时间戳选择器（精确到分钟）
  - Bristol分类选择器（1-7型，图文参考）
  - 气味强度评分（1-5级）
  - 颜色选择器（标准色卡）
  - 排便量选择（小/中/大）
  - 伴随症状多选（腹胀、腹痛等）
  - 趋势图（周/月/季度，折线/柱状）
  - 预警卡片与提醒设置

## PWA与离线策略
- Service Worker：静态资源缓存、API失败时队列缓存（Background Sync）。
- IndexedDB：`stool_entries`与`diet_logs`离线写入队列，在线后自动同步。
- 冲突处理：客户端维护`version`与`updated_at`，服务器端进行字段级合并或最后写入优先，保留冲突快照供用户选择。

## 安全与隐私
- OAuth2.0 + OIDC流程，后端会话/令牌管理，短期Access Token + 长期Refresh Token。
- 端到端加密（可选）：每用户公私钥对；客户端以AES-GCM加密敏感字段；服务器仅存密文。
- 数据在传输层TLS；存储层字段级加密（如症状备注）。
- GDPR：导出（JSON/CSV压缩包）、软删除→硬删除流程、审计日志与数据处理记录。
- 2FA：TOTP（RFC6238），备份恢复码。

## 分析与预警算法（v1）
- 频率趋势：按天计数汇总，周/月/季度滑窗平均与偏差。
- 异常预警：连续≥3天无记录触发“便秘”提醒；连续≥3天Bristol≥6触发“腹泻”提醒。
- 健康评分：权重聚合（频率稳定性40%，Bristol中位数与变异30%，气味强度趋势15%，症状出现率15%）。
- 饮食关联：简单皮尔逊相关或卡方检验，食物标签与Bristol类型/症状的关联热力图。

## 多设备同步与冲突
- 设备登记：`devices`表记录设备指纹。
- 同步游标：按用户分配`last_sync_token`，服务端分页增量返回。
- 冲突策略：最后写入优先 + 服务器保留差异快照；高级模式支持字段级合并规则（如症状数组合并）。

## 质量保障与监控
- 测试：单元（Jest）、端到端（Playwright），覆盖记录与分析核心。
- 安全测试：OAuth流程、令牌泄露防护、加密正确性。
- 监控：API延迟、错误率、前端核心Web Vitals；日志脱敏。
- CI/CD：PR校验、自动化构建与部署、数据库迁移流水线。

## 部署与运维
- 环境：dev/staging/prod分离；配置中心与密钥管理（如Vault/云密钥）。
- 数据备份：每日快照与Point-in-Time Recovery。
- 可扩展性：横向扩容、只读副本用于分析查询。

## 迭代路线与交付物
- Sprint 1（2周）：基础项目脚手架、认证登陆、记录表单与IndexedDB离线写入、Entries CRUD。
- Sprint 2（2周）：趋势图与健康评分v1、预警触发与通知（站内提醒）、同步Pull/Push基础。
- Sprint 3（2周）：端到端加密（可选开关）、冲突解决UI、隐私导出/删除、饮食关联v1。
- 文档与交付：API规范（OpenAPI）、数据字典、部署清单、测试报告。

## 需要确认
- 认证方案偏好（Auth0/Keycloak/自建）与云平台选择。
- 是否启用端到端加密（默认关闭，可用户选择）。
- 前端框架选择最终敲定为React（如要改为Vue请告知）。
- 数据库首选PostgreSQL（如需MongoDB为主也可调整）。

请确认以上计划与阶段目标，我即可开始执行 Phase 1。